===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = fan_part_cooling_pin
shutdown_speed = 1.0

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
Configured MCU 'mcu' (1024 moves)
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-86-g6026a99a'
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
webhooks client 281473189169232: {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
=============== Log rollover at Sun Jan 22 13:18:19 2023 ===============
Stats 224.5: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=3474 bytes_read=37594 bytes_retransmit=9 bytes_invalid=0 send_seq=413 receive_seq=413 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000700 Manta_M8P: temp=44.7 raspberry_pi: temp=50.0  heater_bed: target=0 temp=24.4 pwm=0.000 sysload=0.31 cputime=9.682 memavail=619504 print_time=228.111 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Attempting MCU 'mcu' reset command
webhooks client 281473189169232: Disconnected
Restarting printer
Start printer at Sun Jan 22 13:18:20 2023 (1674393500.8 225.7)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = ^PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
webhooks client 281473181552992: New connection
webhooks client 281473181552992: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-268.840580 slope=1305.652174
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (47.0, 45.4)    | (20.0, 20.0)
  1   | (87.8, 45.4)    | (60.8, 20.0)
  2   | (128.6, 45.4)   | (101.7, 20.0)
  3   | (169.5, 45.4)   | (142.5, 20.0)
  4   | (210.3, 45.4)   | (183.3, 20.0)
  5   | (251.1, 45.4)   | (224.1, 20.0)
  6   | (291.9, 45.4)   | (265.0, 20.0)
  7   | (291.9, 85.4)   | (265.0, 60.0)
  8   | (251.1, 85.4)   | (224.2, 60.0)
  9   | (210.3, 85.4)   | (183.3, 60.0)
  10  | (169.5, 85.4)   | (142.5, 60.0)
  11  | (128.6, 85.4)   | (101.7, 60.0)
  12  | (87.8, 85.4)    | (60.8, 60.0)
  13  | (47.0, 85.4)    | (20.0, 60.0)
  14  | (47.0, 125.4)   | (20.0, 100.0)
  15  | (87.8, 125.4)   | (60.8, 100.0)
  16  | (128.6, 125.4)  | (101.7, 100.0)
  17  | (169.5, 125.4)  | (142.5, 100.0)
  18  | (210.3, 125.4)  | (183.3, 100.0)
  19  | (251.1, 125.4)  | (224.1, 100.0)
  20  | (291.9, 125.4)  | (265.0, 100.0)
  21  | (291.9, 165.4)  | (265.0, 140.0)
  22  | (251.1, 165.4)  | (224.2, 140.0)
  23  | (210.3, 165.4)  | (183.3, 140.0)
  24  | (169.5, 165.4)  | (142.5, 140.0)
  25  | (128.6, 165.4)  | (101.7, 140.0)
  26  | (87.8, 165.4)   | (60.8, 140.0)
  27  | (47.0, 165.4)   | (20.0, 140.0)
  28  | (47.0, 205.4)   | (20.0, 180.0)
  29  | (87.8, 205.4)   | (60.8, 180.0)
  30  | (128.6, 205.4)  | (101.7, 180.0)
  31  | (169.5, 205.4)  | (142.5, 180.0)
  32  | (210.3, 205.4)  | (183.3, 180.0)
  33  | (251.1, 205.4)  | (224.1, 180.0)
  34  | (291.9, 205.4)  | (265.0, 180.0)
  35  | (291.9, 245.4)  | (265.0, 220.0)
  36  | (251.1, 245.4)  | (224.2, 220.0)
  37  | (210.3, 245.4)  | (183.3, 220.0)
  38  | (169.5, 245.4)  | (142.5, 220.0)
  39  | (128.6, 245.4)  | (101.7, 220.0)
  40  | (87.8, 245.4)   | (60.8, 220.0)
  41  | (47.0, 245.4)   | (20.0, 220.0)
  42  | (47.0, 285.4)   | (20.0, 260.0)
  43  | (87.8, 285.4)   | (60.8, 260.0)
  44  | (128.6, 285.4)  | (101.7, 260.0)
  45  | (169.5, 285.4)  | (142.5, 260.0)
  46  | (210.3, 285.4)  | (183.3, 260.0)
  47  | (251.1, 285.4)  | (224.1, 260.0)
  48  | (291.9, 285.4)  | (265.0, 260.0)
TMC stepper_x failed to init: Unable to read tmc uart 'stepper_x' register IFCNT
TMC extruder failed to init: Unable to read tmc uart 'extruder' register IFCNT
TMC stepper_z failed to init: Unable to read tmc uart 'stepper_z' register IFCNT
TMC stepper_z1 failed to init: Unable to read tmc uart 'stepper_z1' register IFCNT
TMC stepper_z2 failed to init: Unable to read tmc uart 'stepper_z2' register IFCNT
Unable to obtain tmc stepper_x phase
Unable to obtain tmc stepper_z phase
Unable to obtain tmc stepper_z1 phase
Unable to obtain tmc stepper_z2 phase
Starting heater checks for extruder
Unable to obtain tmc extruder phase
Stats 228.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2353 bytes_read=5297 bytes_retransmit=9 bytes_invalid=0 send_seq=225 receive_seq=225 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=63999288 Manta_M8P: temp=0.0 raspberry_pi: temp=52.3  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=0.52 cputime=12.021 memavail=616884 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 281473181552992
webhooks: registering remote method 'reboot_machine' for connection id: 281473181552992
webhooks: registering remote method 'pause_job_queue' for connection id: 281473181552992
webhooks: registering remote method 'start_job_queue' for connection id: 281473181552992
Stats 229.6: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2359 bytes_read=5328 bytes_retransmit=9 bytes_invalid=0 send_seq=226 receive_seq=226 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000339 Manta_M8P: temp=0.0 raspberry_pi: temp=51.5  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=0.52 cputime=12.110 memavail=615680 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
Stats 230.6: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2365 bytes_read=5490 bytes_retransmit=9 bytes_invalid=0 send_seq=227 receive_seq=227 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000380 Manta_M8P: temp=43.3 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.48 cputime=12.151 memavail=615432 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 231.6: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2371 bytes_read=5671 bytes_retransmit=9 bytes_invalid=0 send_seq=228 receive_seq=228 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000466 Manta_M8P: temp=43.7 raspberry_pi: temp=51.9  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.48 cputime=12.174 memavail=615184 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 232.6: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2377 bytes_read=5853 bytes_retransmit=9 bytes_invalid=0 send_seq=229 receive_seq=229 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000497 Manta_M8P: temp=43.7 raspberry_pi: temp=51.4  heater_bed: target=0 temp=23.9 pwm=0.000 sysload=0.48 cputime=12.198 memavail=614932 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 233.6: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2383 bytes_read=6035 bytes_retransmit=9 bytes_invalid=0 send_seq=230 receive_seq=230 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000567 Manta_M8P: temp=44.0 raspberry_pi: temp=51.1  heater_bed: target=0 temp=24.3 pwm=0.000 sysload=0.48 cputime=12.221 memavail=614688 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 234.6: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2389 bytes_read=6249 bytes_retransmit=9 bytes_invalid=0 send_seq=231 receive_seq=231 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000592 Manta_M8P: temp=44.1 raspberry_pi: temp=51.3  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.48 cputime=12.246 memavail=614444 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 235.6: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2395 bytes_read=6431 bytes_retransmit=9 bytes_invalid=0 send_seq=232 receive_seq=232 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000618 Manta_M8P: temp=44.3 raspberry_pi: temp=51.1  heater_bed: target=0 temp=24.5 pwm=0.000 sysload=0.44 cputime=12.269 memavail=613720 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 236.6: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2401 bytes_read=6613 bytes_retransmit=9 bytes_invalid=0 send_seq=233 receive_seq=233 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000634 Manta_M8P: temp=44.2 raspberry_pi: temp=51.2  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.44 cputime=12.293 memavail=613220 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 237.6: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2437 bytes_read=6804 bytes_retransmit=9 bytes_invalid=0 send_seq=236 receive_seq=236 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000652 Manta_M8P: temp=44.3 raspberry_pi: temp=50.7  heater_bed: target=0 temp=24.4 pwm=0.000 sysload=0.44 cputime=12.319 memavail=612984 print_time=12.539 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.7 pwm=0.000
Stats 238.6: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2443 bytes_read=6986 bytes_retransmit=9 bytes_invalid=0 send_seq=237 receive_seq=237 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000658 Manta_M8P: temp=44.5 raspberry_pi: temp=50.7  heater_bed: target=0 temp=23.8 pwm=0.000 sysload=0.44 cputime=12.343 memavail=613240 print_time=12.539 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 239.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2462 bytes_read=7187 bytes_retransmit=9 bytes_invalid=0 send_seq=239 receive_seq=239 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000684 Manta_M8P: temp=44.5 raspberry_pi: temp=50.8  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.44 cputime=12.370 memavail=612736 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 240.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2468 bytes_read=7368 bytes_retransmit=9 bytes_invalid=0 send_seq=240 receive_seq=240 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000680 Manta_M8P: temp=44.4 raspberry_pi: temp=51.3  heater_bed: target=0 temp=24.3 pwm=0.000 sysload=0.41 cputime=12.394 memavail=612736 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 241.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2474 bytes_read=7565 bytes_retransmit=9 bytes_invalid=0 send_seq=241 receive_seq=241 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000675 Manta_M8P: temp=44.5 raspberry_pi: temp=50.9  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.41 cputime=12.418 memavail=612736 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 242.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2480 bytes_read=7732 bytes_retransmit=9 bytes_invalid=0 send_seq=242 receive_seq=242 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000676 Manta_M8P: temp=44.7 raspberry_pi: temp=51.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.41 cputime=12.442 memavail=612948 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 243.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2486 bytes_read=7928 bytes_retransmit=9 bytes_invalid=0 send_seq=243 receive_seq=243 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000679 Manta_M8P: temp=44.6 raspberry_pi: temp=51.0  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.41 cputime=12.466 memavail=613280 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 244.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000011 bytes_write=2492 bytes_read=8124 bytes_retransmit=9 bytes_invalid=0 send_seq=244 receive_seq=244 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000681 Manta_M8P: temp=44.6 raspberry_pi: temp=50.7  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.41 cputime=12.490 memavail=613240 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 245.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000011 bytes_write=2498 bytes_read=8291 bytes_retransmit=9 bytes_invalid=0 send_seq=245 receive_seq=245 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000681 Manta_M8P: temp=44.7 raspberry_pi: temp=50.9  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.37 cputime=12.513 memavail=612836 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 246.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000011 bytes_write=2504 bytes_read=8487 bytes_retransmit=9 bytes_invalid=0 send_seq=246 receive_seq=246 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000695 Manta_M8P: temp=44.7 raspberry_pi: temp=51.4  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.37 cputime=12.538 memavail=612788 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 247.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000011 bytes_write=2510 bytes_read=8670 bytes_retransmit=9 bytes_invalid=0 send_seq=247 receive_seq=247 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000691 Manta_M8P: temp=44.8 raspberry_pi: temp=51.6  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.37 cputime=12.562 memavail=612600 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 248.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000011 bytes_write=2516 bytes_read=8838 bytes_retransmit=9 bytes_invalid=0 send_seq=248 receive_seq=248 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000691 Manta_M8P: temp=45.1 raspberry_pi: temp=50.8  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.37 cputime=12.585 memavail=612812 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 249.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2522 bytes_read=9049 bytes_retransmit=9 bytes_invalid=0 send_seq=249 receive_seq=249 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000689 Manta_M8P: temp=44.8 raspberry_pi: temp=51.6  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.37 cputime=12.609 memavail=612896 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 250.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2528 bytes_read=9232 bytes_retransmit=9 bytes_invalid=0 send_seq=250 receive_seq=250 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000699 Manta_M8P: temp=44.8 raspberry_pi: temp=51.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.34 cputime=12.632 memavail=612856 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.0 pwm=0.000
Stats 251.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2534 bytes_read=9400 bytes_retransmit=9 bytes_invalid=0 send_seq=251 receive_seq=251 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000698 Manta_M8P: temp=45.1 raspberry_pi: temp=51.8  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.34 cputime=12.655 memavail=612656 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 252.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2540 bytes_read=9597 bytes_retransmit=9 bytes_invalid=0 send_seq=252 receive_seq=252 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000696 Manta_M8P: temp=45.0 raspberry_pi: temp=51.6  heater_bed: target=0 temp=24.3 pwm=0.000 sysload=0.34 cputime=12.679 memavail=612856 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.0 pwm=0.000
Stats 253.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2546 bytes_read=9780 bytes_retransmit=9 bytes_invalid=0 send_seq=253 receive_seq=253 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000702 Manta_M8P: temp=45.0 raspberry_pi: temp=51.3  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.34 cputime=12.702 memavail=612912 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 254.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2552 bytes_read=9962 bytes_retransmit=9 bytes_invalid=0 send_seq=254 receive_seq=254 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000697 Manta_M8P: temp=45.1 raspberry_pi: temp=51.0  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.34 cputime=12.726 memavail=613180 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 255.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2558 bytes_read=10159 bytes_retransmit=9 bytes_invalid=0 send_seq=255 receive_seq=255 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000694 Manta_M8P: temp=45.3 raspberry_pi: temp=51.3  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.31 cputime=12.750 memavail=613472 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 256.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2564 bytes_read=10342 bytes_retransmit=9 bytes_invalid=0 send_seq=256 receive_seq=256 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000695 Manta_M8P: temp=44.9 raspberry_pi: temp=50.8  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.31 cputime=12.774 memavail=613224 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 257.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2570 bytes_read=10510 bytes_retransmit=9 bytes_invalid=0 send_seq=257 receive_seq=257 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000694 Manta_M8P: temp=45.3 raspberry_pi: temp=51.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.31 cputime=12.797 memavail=613240 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 258.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2576 bytes_read=10707 bytes_retransmit=9 bytes_invalid=0 send_seq=258 receive_seq=258 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000690 Manta_M8P: temp=45.0 raspberry_pi: temp=51.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.31 cputime=12.821 memavail=612988 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 259.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2582 bytes_read=10904 bytes_retransmit=9 bytes_invalid=0 send_seq=259 receive_seq=259 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000686 Manta_M8P: temp=45.0 raspberry_pi: temp=51.0  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.31 cputime=12.844 memavail=612744 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 260.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2588 bytes_read=11072 bytes_retransmit=9 bytes_invalid=0 send_seq=260 receive_seq=260 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000685 Manta_M8P: temp=45.0 raspberry_pi: temp=51.2  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.29 cputime=12.868 memavail=612944 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 261.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2594 bytes_read=11269 bytes_retransmit=9 bytes_invalid=0 send_seq=261 receive_seq=261 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000683 Manta_M8P: temp=45.2 raspberry_pi: temp=51.0  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.29 cputime=12.891 memavail=612996 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 262.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2600 bytes_read=11452 bytes_retransmit=9 bytes_invalid=0 send_seq=262 receive_seq=262 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000682 Manta_M8P: temp=45.2 raspberry_pi: temp=51.7  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.29 cputime=12.915 memavail=613196 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 263.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2606 bytes_read=11620 bytes_retransmit=9 bytes_invalid=0 send_seq=263 receive_seq=263 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000685 Manta_M8P: temp=45.2 raspberry_pi: temp=51.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.29 cputime=12.939 memavail=613252 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 264.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2612 bytes_read=11831 bytes_retransmit=9 bytes_invalid=0 send_seq=264 receive_seq=264 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000688 Manta_M8P: temp=45.2 raspberry_pi: temp=51.1  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.29 cputime=12.963 memavail=612748 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 265.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2618 bytes_read=12014 bytes_retransmit=9 bytes_invalid=0 send_seq=265 receive_seq=265 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000686 Manta_M8P: temp=45.2 raspberry_pi: temp=51.6  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.27 cputime=12.988 memavail=612704 print_time=14.373 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 266.6: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2630 bytes_read=12198 bytes_retransmit=9 bytes_invalid=0 send_seq=267 receive_seq=267 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000691 Manta_M8P: temp=45.2 raspberry_pi: temp=51.6  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.27 cputime=13.016 memavail=612260 print_time=42.834 buffer_time=0.790 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Attempting MCU 'mcu' reset command
webhooks client 281473181552992: Disconnected
Restarting printer
Start printer at Sun Jan 22 13:19:03 2023 (1674393543.7 268.6)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = !PE4
shutdown_speed = 1.0
tachometer_pin = ^PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
webhooks client 281473181545712: New connection
webhooks client 281473181545712: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-268.840580 slope=1305.652174
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (47.0, 45.4)    | (20.0, 20.0)
  1   | (87.8, 45.4)    | (60.8, 20.0)
  2   | (128.6, 45.4)   | (101.7, 20.0)
  3   | (169.5, 45.4)   | (142.5, 20.0)
  4   | (210.3, 45.4)   | (183.3, 20.0)
  5   | (251.1, 45.4)   | (224.1, 20.0)
  6   | (291.9, 45.4)   | (265.0, 20.0)
  7   | (291.9, 85.4)   | (265.0, 60.0)
  8   | (251.1, 85.4)   | (224.2, 60.0)
  9   | (210.3, 85.4)   | (183.3, 60.0)
  10  | (169.5, 85.4)   | (142.5, 60.0)
  11  | (128.6, 85.4)   | (101.7, 60.0)
  12  | (87.8, 85.4)    | (60.8, 60.0)
  13  | (47.0, 85.4)    | (20.0, 60.0)
  14  | (47.0, 125.4)   | (20.0, 100.0)
  15  | (87.8, 125.4)   | (60.8, 100.0)
  16  | (128.6, 125.4)  | (101.7, 100.0)
  17  | (169.5, 125.4)  | (142.5, 100.0)
  18  | (210.3, 125.4)  | (183.3, 100.0)
  19  | (251.1, 125.4)  | (224.1, 100.0)
  20  | (291.9, 125.4)  | (265.0, 100.0)
  21  | (291.9, 165.4)  | (265.0, 140.0)
  22  | (251.1, 165.4)  | (224.2, 140.0)
  23  | (210.3, 165.4)  | (183.3, 140.0)
  24  | (169.5, 165.4)  | (142.5, 140.0)
  25  | (128.6, 165.4)  | (101.7, 140.0)
  26  | (87.8, 165.4)   | (60.8, 140.0)
  27  | (47.0, 165.4)   | (20.0, 140.0)
  28  | (47.0, 205.4)   | (20.0, 180.0)
  29  | (87.8, 205.4)   | (60.8, 180.0)
  30  | (128.6, 205.4)  | (101.7, 180.0)
  31  | (169.5, 205.4)  | (142.5, 180.0)
  32  | (210.3, 205.4)  | (183.3, 180.0)
  33  | (251.1, 205.4)  | (224.1, 180.0)
  34  | (291.9, 205.4)  | (265.0, 180.0)
  35  | (291.9, 245.4)  | (265.0, 220.0)
  36  | (251.1, 245.4)  | (224.2, 220.0)
  37  | (210.3, 245.4)  | (183.3, 220.0)
  38  | (169.5, 245.4)  | (142.5, 220.0)
  39  | (128.6, 245.4)  | (101.7, 220.0)
  40  | (87.8, 245.4)   | (60.8, 220.0)
  41  | (47.0, 245.4)   | (20.0, 220.0)
  42  | (47.0, 285.4)   | (20.0, 260.0)
  43  | (87.8, 285.4)   | (60.8, 260.0)
  44  | (128.6, 285.4)  | (101.7, 260.0)
  45  | (169.5, 285.4)  | (142.5, 260.0)
  46  | (210.3, 285.4)  | (183.3, 260.0)
  47  | (251.1, 285.4)  | (224.1, 260.0)
  48  | (291.9, 285.4)  | (265.0, 260.0)
TMC stepper_x failed to init: Unable to read tmc uart 'stepper_x' register IFCNT
TMC extruder failed to init: Unable to read tmc uart 'extruder' register IFCNT
TMC stepper_z failed to init: Unable to read tmc uart 'stepper_z' register IFCNT
TMC stepper_z1 failed to init: Unable to read tmc uart 'stepper_z1' register IFCNT
TMC stepper_z2 failed to init: Unable to read tmc uart 'stepper_z2' register IFCNT
Unable to obtain tmc stepper_x phase
Unable to obtain tmc stepper_z phase
Unable to obtain tmc stepper_z1 phase
Unable to obtain tmc stepper_z2 phase
Starting heater checks for extruder
Unable to obtain tmc extruder phase
Stats 271.5: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2355 bytes_read=5297 bytes_retransmit=9 bytes_invalid=0 send_seq=225 receive_seq=225 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64002571 Manta_M8P: temp=0.0 raspberry_pi: temp=54.1  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=0.33 cputime=15.373 memavail=611244 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 281473181545712
webhooks: registering remote method 'reboot_machine' for connection id: 281473181545712
webhooks: registering remote method 'pause_job_queue' for connection id: 281473181545712
webhooks: registering remote method 'start_job_queue' for connection id: 281473181545712
Stats 272.5: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2361 bytes_read=5342 bytes_retransmit=9 bytes_invalid=0 send_seq=226 receive_seq=226 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64001224 Manta_M8P: temp=0.0 raspberry_pi: temp=52.6  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=0.33 cputime=15.463 memavail=612008 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
Stats 273.5: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2367 bytes_read=5509 bytes_retransmit=9 bytes_invalid=0 send_seq=227 receive_seq=227 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000807 Manta_M8P: temp=43.6 raspberry_pi: temp=53.0  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.33 cputime=15.504 memavail=612008 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.0 pwm=0.000
Stats 274.5: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2373 bytes_read=5705 bytes_retransmit=9 bytes_invalid=0 send_seq=228 receive_seq=228 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000854 Manta_M8P: temp=43.9 raspberry_pi: temp=52.7  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.33 cputime=15.528 memavail=612012 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 275.5: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2379 bytes_read=5887 bytes_retransmit=9 bytes_invalid=0 send_seq=229 receive_seq=229 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000790 Manta_M8P: temp=44.3 raspberry_pi: temp=51.9  heater_bed: target=0 temp=23.9 pwm=0.000 sysload=0.30 cputime=15.552 memavail=612020 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.0 pwm=0.000
Stats 276.5: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2385 bytes_read=6054 bytes_retransmit=9 bytes_invalid=0 send_seq=230 receive_seq=230 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000763 Manta_M8P: temp=44.2 raspberry_pi: temp=52.3  heater_bed: target=0 temp=24.3 pwm=0.000 sysload=0.30 cputime=15.575 memavail=612020 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 277.5: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2391 bytes_read=6264 bytes_retransmit=9 bytes_invalid=0 send_seq=231 receive_seq=231 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000739 Manta_M8P: temp=44.7 raspberry_pi: temp=51.6  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.30 cputime=15.599 memavail=612020 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 278.5: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2397 bytes_read=6446 bytes_retransmit=9 bytes_invalid=0 send_seq=232 receive_seq=232 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000723 Manta_M8P: temp=44.7 raspberry_pi: temp=51.7  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.30 cputime=15.623 memavail=612048 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 279.5: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2403 bytes_read=6613 bytes_retransmit=9 bytes_invalid=0 send_seq=233 receive_seq=233 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000755 Manta_M8P: temp=44.7 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.30 cputime=15.646 memavail=612048 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 280.5: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2409 bytes_read=6809 bytes_retransmit=9 bytes_invalid=0 send_seq=234 receive_seq=234 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000743 Manta_M8P: temp=45.0 raspberry_pi: temp=51.7  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.27 cputime=15.670 memavail=612056 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 281.5: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2415 bytes_read=6991 bytes_retransmit=9 bytes_invalid=0 send_seq=235 receive_seq=235 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000720 Manta_M8P: temp=45.1 raspberry_pi: temp=51.7  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.27 cputime=15.694 memavail=612056 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 282.5: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2421 bytes_read=7173 bytes_retransmit=9 bytes_invalid=0 send_seq=236 receive_seq=236 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000718 Manta_M8P: temp=45.1 raspberry_pi: temp=51.8  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.27 cputime=15.722 memavail=611808 print_time=15.299 buffer_time=0.257 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Attempting MCU 'mcu' reset command
webhooks client 281473181545712: Disconnected
Restarting printer
Start printer at Sun Jan 22 13:19:19 2023 (1674393559.0 283.9)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = ^PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
webhooks client 281473189971856: New connection
webhooks client 281473189971856: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-268.840580 slope=1305.652174
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (47.0, 45.4)    | (20.0, 20.0)
  1   | (87.8, 45.4)    | (60.8, 20.0)
  2   | (128.6, 45.4)   | (101.7, 20.0)
  3   | (169.5, 45.4)   | (142.5, 20.0)
  4   | (210.3, 45.4)   | (183.3, 20.0)
  5   | (251.1, 45.4)   | (224.1, 20.0)
  6   | (291.9, 45.4)   | (265.0, 20.0)
  7   | (291.9, 85.4)   | (265.0, 60.0)
  8   | (251.1, 85.4)   | (224.2, 60.0)
  9   | (210.3, 85.4)   | (183.3, 60.0)
  10  | (169.5, 85.4)   | (142.5, 60.0)
  11  | (128.6, 85.4)   | (101.7, 60.0)
  12  | (87.8, 85.4)    | (60.8, 60.0)
  13  | (47.0, 85.4)    | (20.0, 60.0)
  14  | (47.0, 125.4)   | (20.0, 100.0)
  15  | (87.8, 125.4)   | (60.8, 100.0)
  16  | (128.6, 125.4)  | (101.7, 100.0)
  17  | (169.5, 125.4)  | (142.5, 100.0)
  18  | (210.3, 125.4)  | (183.3, 100.0)
  19  | (251.1, 125.4)  | (224.1, 100.0)
  20  | (291.9, 125.4)  | (265.0, 100.0)
  21  | (291.9, 165.4)  | (265.0, 140.0)
  22  | (251.1, 165.4)  | (224.2, 140.0)
  23  | (210.3, 165.4)  | (183.3, 140.0)
  24  | (169.5, 165.4)  | (142.5, 140.0)
  25  | (128.6, 165.4)  | (101.7, 140.0)
  26  | (87.8, 165.4)   | (60.8, 140.0)
  27  | (47.0, 165.4)   | (20.0, 140.0)
  28  | (47.0, 205.4)   | (20.0, 180.0)
  29  | (87.8, 205.4)   | (60.8, 180.0)
  30  | (128.6, 205.4)  | (101.7, 180.0)
  31  | (169.5, 205.4)  | (142.5, 180.0)
  32  | (210.3, 205.4)  | (183.3, 180.0)
  33  | (251.1, 205.4)  | (224.1, 180.0)
  34  | (291.9, 205.4)  | (265.0, 180.0)
  35  | (291.9, 245.4)  | (265.0, 220.0)
  36  | (251.1, 245.4)  | (224.2, 220.0)
  37  | (210.3, 245.4)  | (183.3, 220.0)
  38  | (169.5, 245.4)  | (142.5, 220.0)
  39  | (128.6, 245.4)  | (101.7, 220.0)
  40  | (87.8, 245.4)   | (60.8, 220.0)
  41  | (47.0, 245.4)   | (20.0, 220.0)
  42  | (47.0, 285.4)   | (20.0, 260.0)
  43  | (87.8, 285.4)   | (60.8, 260.0)
  44  | (128.6, 285.4)  | (101.7, 260.0)
  45  | (169.5, 285.4)  | (142.5, 260.0)
  46  | (210.3, 285.4)  | (183.3, 260.0)
  47  | (251.1, 285.4)  | (224.1, 260.0)
  48  | (291.9, 285.4)  | (265.0, 260.0)
TMC stepper_x failed to init: Unable to read tmc uart 'stepper_x' register IFCNT
TMC extruder failed to init: Unable to read tmc uart 'extruder' register IFCNT
TMC stepper_z failed to init: Unable to read tmc uart 'stepper_z' register IFCNT
TMC stepper_z1 failed to init: Unable to read tmc uart 'stepper_z1' register IFCNT
TMC stepper_z2 failed to init: Unable to read tmc uart 'stepper_z2' register IFCNT
Unable to obtain tmc stepper_x phase
Unable to obtain tmc stepper_z phase
Unable to obtain tmc stepper_z1 phase
Unable to obtain tmc stepper_z2 phase
Starting heater checks for extruder
Unable to obtain tmc extruder phase
Stats 286.9: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2353 bytes_read=5297 bytes_retransmit=9 bytes_invalid=0 send_seq=225 receive_seq=225 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=63999305 Manta_M8P: temp=0.0 raspberry_pi: temp=54.2  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=0.49 cputime=18.095 memavail=611592 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 281473189971856
webhooks: registering remote method 'reboot_machine' for connection id: 281473189971856
webhooks: registering remote method 'pause_job_queue' for connection id: 281473189971856
webhooks: registering remote method 'start_job_queue' for connection id: 281473189971856
Stats 287.9: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2359 bytes_read=5346 bytes_retransmit=9 bytes_invalid=0 send_seq=226 receive_seq=226 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000093 Manta_M8P: temp=0.0 raspberry_pi: temp=54.0  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=0.49 cputime=18.183 memavail=611464 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
Stats 288.9: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2365 bytes_read=5513 bytes_retransmit=9 bytes_invalid=0 send_seq=227 receive_seq=227 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000299 Manta_M8P: temp=43.6 raspberry_pi: temp=54.0  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.49 cputime=18.225 memavail=610996 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 289.9: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2371 bytes_read=5709 bytes_retransmit=9 bytes_invalid=0 send_seq=228 receive_seq=228 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000407 Manta_M8P: temp=43.8 raspberry_pi: temp=52.8  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.49 cputime=18.249 memavail=610528 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 290.9: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2377 bytes_read=5891 bytes_retransmit=9 bytes_invalid=0 send_seq=229 receive_seq=229 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000479 Manta_M8P: temp=44.4 raspberry_pi: temp=52.9  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.45 cputime=18.273 memavail=610280 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 291.9: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2383 bytes_read=6058 bytes_retransmit=9 bytes_invalid=0 send_seq=230 receive_seq=230 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000535 Manta_M8P: temp=44.3 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.45 cputime=18.296 memavail=610280 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 292.9: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2389 bytes_read=6268 bytes_retransmit=9 bytes_invalid=0 send_seq=231 receive_seq=231 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000560 Manta_M8P: temp=44.9 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.45 cputime=18.320 memavail=609776 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 293.9: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2395 bytes_read=6450 bytes_retransmit=9 bytes_invalid=0 send_seq=232 receive_seq=232 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000578 Manta_M8P: temp=45.0 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.45 cputime=18.343 memavail=609552 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 294.9: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2401 bytes_read=6617 bytes_retransmit=9 bytes_invalid=0 send_seq=233 receive_seq=233 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000667 Manta_M8P: temp=45.1 raspberry_pi: temp=52.8  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.45 cputime=18.367 memavail=609048 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 295.9: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2407 bytes_read=6813 bytes_retransmit=9 bytes_invalid=0 send_seq=234 receive_seq=234 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000658 Manta_M8P: temp=45.3 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.42 cputime=18.390 memavail=609048 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 296.9: gcodein=0  mcu: mcu_awake=0.003 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2413 bytes_read=6995 bytes_retransmit=9 bytes_invalid=0 send_seq=235 receive_seq=235 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000641 Manta_M8P: temp=45.1 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.42 cputime=18.414 memavail=608552 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 297.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2419 bytes_read=7176 bytes_retransmit=9 bytes_invalid=0 send_seq=236 receive_seq=236 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000632 Manta_M8P: temp=45.2 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.42 cputime=18.438 memavail=608560 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 298.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2425 bytes_read=7372 bytes_retransmit=9 bytes_invalid=0 send_seq=237 receive_seq=237 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000647 Manta_M8P: temp=45.3 raspberry_pi: temp=53.0  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.42 cputime=18.463 memavail=608344 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 299.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2431 bytes_read=7554 bytes_retransmit=9 bytes_invalid=0 send_seq=238 receive_seq=238 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000636 Manta_M8P: temp=45.3 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.42 cputime=18.486 memavail=608100 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 300.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2437 bytes_read=7721 bytes_retransmit=9 bytes_invalid=0 send_seq=239 receive_seq=239 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000634 Manta_M8P: temp=45.5 raspberry_pi: temp=52.4  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.38 cputime=18.510 memavail=608612 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 301.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2443 bytes_read=7917 bytes_retransmit=9 bytes_invalid=0 send_seq=240 receive_seq=240 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000629 Manta_M8P: temp=45.5 raspberry_pi: temp=52.1  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.38 cputime=18.534 memavail=608360 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 302.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2449 bytes_read=8113 bytes_retransmit=9 bytes_invalid=0 send_seq=241 receive_seq=241 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000621 Manta_M8P: temp=45.4 raspberry_pi: temp=52.1  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.38 cputime=18.558 memavail=608360 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 303.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2455 bytes_read=8280 bytes_retransmit=9 bytes_invalid=0 send_seq=242 receive_seq=242 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000622 Manta_M8P: temp=45.7 raspberry_pi: temp=52.7  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.38 cputime=18.582 memavail=608364 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 304.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2461 bytes_read=8476 bytes_retransmit=9 bytes_invalid=0 send_seq=243 receive_seq=243 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000623 Manta_M8P: temp=45.5 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.38 cputime=18.606 memavail=608112 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.1 pwm=0.000
Stats 305.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2467 bytes_read=8658 bytes_retransmit=9 bytes_invalid=0 send_seq=244 receive_seq=244 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000621 Manta_M8P: temp=45.7 raspberry_pi: temp=51.9  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.35 cputime=18.630 memavail=608112 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 306.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2473 bytes_read=8825 bytes_retransmit=9 bytes_invalid=0 send_seq=245 receive_seq=245 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000618 Manta_M8P: temp=45.5 raspberry_pi: temp=52.4  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.35 cputime=18.653 memavail=608380 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 307.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2479 bytes_read=9035 bytes_retransmit=9 bytes_invalid=0 send_seq=246 receive_seq=246 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000621 Manta_M8P: temp=45.7 raspberry_pi: temp=52.1  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.35 cputime=18.678 memavail=608660 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 308.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2485 bytes_read=9218 bytes_retransmit=9 bytes_invalid=0 send_seq=247 receive_seq=247 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000624 Manta_M8P: temp=45.7 raspberry_pi: temp=52.3  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.35 cputime=18.701 memavail=608436 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 309.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2491 bytes_read=9386 bytes_retransmit=9 bytes_invalid=0 send_seq=248 receive_seq=248 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000626 Manta_M8P: temp=45.9 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.35 cputime=18.724 memavail=609228 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 310.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2497 bytes_read=9583 bytes_retransmit=9 bytes_invalid=0 send_seq=249 receive_seq=249 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000627 Manta_M8P: temp=45.8 raspberry_pi: temp=52.4  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.32 cputime=18.748 memavail=609248 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 311.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2503 bytes_read=9766 bytes_retransmit=9 bytes_invalid=0 send_seq=250 receive_seq=250 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000628 Manta_M8P: temp=45.9 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.32 cputime=18.772 memavail=609248 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 312.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2509 bytes_read=9948 bytes_retransmit=9 bytes_invalid=0 send_seq=251 receive_seq=251 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000635 Manta_M8P: temp=46.0 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.32 cputime=18.795 memavail=609500 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 313.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2515 bytes_read=10145 bytes_retransmit=9 bytes_invalid=0 send_seq=252 receive_seq=252 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000643 Manta_M8P: temp=46.0 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.32 cputime=18.819 memavail=609276 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 314.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2521 bytes_read=10328 bytes_retransmit=9 bytes_invalid=0 send_seq=253 receive_seq=253 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000644 Manta_M8P: temp=45.9 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.32 cputime=18.843 memavail=609276 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 315.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2527 bytes_read=10496 bytes_retransmit=9 bytes_invalid=0 send_seq=254 receive_seq=254 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000644 Manta_M8P: temp=45.8 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.30 cputime=18.866 memavail=609336 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 316.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2533 bytes_read=10693 bytes_retransmit=9 bytes_invalid=0 send_seq=255 receive_seq=255 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000650 Manta_M8P: temp=45.9 raspberry_pi: temp=52.4  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.30 cputime=18.890 memavail=609848 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 317.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2539 bytes_read=10890 bytes_retransmit=9 bytes_invalid=0 send_seq=256 receive_seq=256 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000649 Manta_M8P: temp=46.1 raspberry_pi: temp=52.1  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.30 cputime=18.914 memavail=609856 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 318.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2545 bytes_read=11058 bytes_retransmit=9 bytes_invalid=0 send_seq=257 receive_seq=257 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000649 Manta_M8P: temp=45.9 raspberry_pi: temp=53.0  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.30 cputime=18.938 memavail=609884 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 319.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2551 bytes_read=11255 bytes_retransmit=9 bytes_invalid=0 send_seq=258 receive_seq=258 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000660 Manta_M8P: temp=45.9 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.30 cputime=18.962 memavail=610668 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 320.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2557 bytes_read=11438 bytes_retransmit=9 bytes_invalid=0 send_seq=259 receive_seq=259 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000658 Manta_M8P: temp=46.1 raspberry_pi: temp=52.3  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.27 cputime=18.986 memavail=610672 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 321.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2563 bytes_read=11606 bytes_retransmit=9 bytes_invalid=0 send_seq=260 receive_seq=260 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000656 Manta_M8P: temp=46.0 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.27 cputime=19.009 memavail=610472 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 322.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2569 bytes_read=11817 bytes_retransmit=9 bytes_invalid=0 send_seq=261 receive_seq=261 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000655 Manta_M8P: temp=46.0 raspberry_pi: temp=52.2  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.27 cputime=19.034 memavail=610476 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 323.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2581 bytes_read=12000 bytes_retransmit=9 bytes_invalid=0 send_seq=263 receive_seq=262 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000654 Manta_M8P: temp=45.9 raspberry_pi: temp=52.8  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.27 cputime=19.058 memavail=610264 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 324.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2587 bytes_read=12184 bytes_retransmit=9 bytes_invalid=0 send_seq=264 receive_seq=264 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000651 Manta_M8P: temp=46.2 raspberry_pi: temp=52.8  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.27 cputime=19.083 memavail=610264 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 325.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2593 bytes_read=12381 bytes_retransmit=9 bytes_invalid=0 send_seq=265 receive_seq=265 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000652 Manta_M8P: temp=46.1 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.25 cputime=19.107 memavail=610264 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 326.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2599 bytes_read=12564 bytes_retransmit=9 bytes_invalid=0 send_seq=266 receive_seq=266 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000651 Manta_M8P: temp=46.1 raspberry_pi: temp=52.7  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.25 cputime=19.131 memavail=610012 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 327.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2605 bytes_read=12746 bytes_retransmit=9 bytes_invalid=0 send_seq=267 receive_seq=267 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000650 Manta_M8P: temp=46.2 raspberry_pi: temp=51.9  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.25 cputime=19.154 memavail=610012 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 328.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2611 bytes_read=12943 bytes_retransmit=9 bytes_invalid=0 send_seq=268 receive_seq=268 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000650 Manta_M8P: temp=46.1 raspberry_pi: temp=52.1  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.25 cputime=19.178 memavail=609548 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 329.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2617 bytes_read=13126 bytes_retransmit=9 bytes_invalid=0 send_seq=269 receive_seq=269 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000648 Manta_M8P: temp=46.1 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.25 cputime=19.202 memavail=609556 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 330.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2623 bytes_read=13294 bytes_retransmit=9 bytes_invalid=0 send_seq=270 receive_seq=270 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000647 Manta_M8P: temp=46.0 raspberry_pi: temp=52.7  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.23 cputime=19.225 memavail=609316 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 331.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2629 bytes_read=13491 bytes_retransmit=9 bytes_invalid=0 send_seq=271 receive_seq=271 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000648 Manta_M8P: temp=46.1 raspberry_pi: temp=52.8  heater_bed: target=0 temp=24.3 pwm=0.000 sysload=0.23 cputime=19.248 memavail=609072 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 332.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2635 bytes_read=13688 bytes_retransmit=9 bytes_invalid=0 send_seq=272 receive_seq=272 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000648 Manta_M8P: temp=46.2 raspberry_pi: temp=52.9  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.23 cputime=19.272 memavail=609352 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 333.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2641 bytes_read=13856 bytes_retransmit=9 bytes_invalid=0 send_seq=273 receive_seq=273 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000653 Manta_M8P: temp=46.1 raspberry_pi: temp=52.9  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.23 cputime=19.295 memavail=609604 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.2 pwm=0.000
Stats 334.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2647 bytes_read=14053 bytes_retransmit=9 bytes_invalid=0 send_seq=274 receive_seq=274 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000652 Manta_M8P: temp=46.0 raspberry_pi: temp=52.4  heater_bed: target=0 temp=24.0 pwm=0.000 sysload=0.23 cputime=19.318 memavail=609604 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 335.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2653 bytes_read=14236 bytes_retransmit=9 bytes_invalid=0 send_seq=275 receive_seq=275 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000652 Manta_M8P: temp=46.3 raspberry_pi: temp=52.5  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.21 cputime=19.341 memavail=609604 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 336.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2659 bytes_read=14404 bytes_retransmit=9 bytes_invalid=0 send_seq=276 receive_seq=276 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000654 Manta_M8P: temp=46.2 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.21 cputime=19.365 memavail=609856 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 337.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2665 bytes_read=14615 bytes_retransmit=9 bytes_invalid=0 send_seq=277 receive_seq=277 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000653 Manta_M8P: temp=46.3 raspberry_pi: temp=52.8  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.21 cputime=19.390 memavail=610368 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 338.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2671 bytes_read=14798 bytes_retransmit=9 bytes_invalid=0 send_seq=278 receive_seq=278 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000652 Manta_M8P: temp=46.0 raspberry_pi: temp=53.0  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.21 cputime=19.414 memavail=610124 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.4 pwm=0.000
Stats 339.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2677 bytes_read=14966 bytes_retransmit=9 bytes_invalid=0 send_seq=279 receive_seq=279 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000651 Manta_M8P: temp=46.1 raspberry_pi: temp=52.6  heater_bed: target=0 temp=24.2 pwm=0.000 sysload=0.21 cputime=19.438 memavail=610416 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 340.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2683 bytes_read=15163 bytes_retransmit=9 bytes_invalid=0 send_seq=280 receive_seq=280 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000650 Manta_M8P: temp=46.4 raspberry_pi: temp=52.3  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.20 cputime=19.463 memavail=610704 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 341.9: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2689 bytes_read=15346 bytes_retransmit=9 bytes_invalid=0 send_seq=281 receive_seq=281 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000650 Manta_M8P: temp=46.3 raspberry_pi: temp=52.7  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.20 cputime=19.486 memavail=610460 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=24.3 pwm=0.000
Stats 724.3: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=5017 bytes_read=86029 bytes_retransmit=9 bytes_invalid=0 send_seq=669 receive_seq=669 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000609 Manta_M8P: temp=48.7 raspberry_pi: temp=56.7  heater_bed: target=0 temp=24.1 pwm=0.000 sysload=0.17 cputime=27.967 memavail=605168 print_time=441.491 buffer_time=0.025 print_stall=0 extruder: target=0 temp=24.6 pwm=0.000
Attempting MCU 'mcu' reset command
webhooks client 281473189971856: Disconnected
Restarting printer
Start printer at Sun Jan 22 13:26:40 2023 (1674394000.6 725.5)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01
enable_pin = VF4

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
webhooks client 281473182354688: New connection
webhooks client 281473182354688: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-268.840580 slope=1305.652174
Sending MCU 'mcu' printer configuration...
Config error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/mcu.py", line 686, in _send_config
    self._serial.send(c)
  File "/home/pi/klipper/klippy/serialhdl.py", line 256, in send
    cmd = self.msgparser.create_command(msg)
  File "/home/pi/klipper/klippy/msgproto.py", line 344, in create_command
    cmd = mp.encode_by_name(**argparts)
  File "/home/pi/klipper/klippy/msgproto.py", line 181, in encode_by_name
    t.encode(out, params[name])
  File "/home/pi/klipper/klippy/msgproto.py", line 108, in encode
    raise enumeration_error(self.enum_name, v)
msgproto.enumeration_error: Unknown value 'VF4' in enumeration 'pin'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/pi/klipper/klippy/klippy.py", line 180, in _connect
    cb()
  File "/home/pi/klipper/klippy/mcu.py", line 732, in _connect
    self._send_config(None)
  File "/home/pi/klipper/klippy/mcu.py", line 697, in _send_config
    raise self._printer.config_error(
configparser.Error: Pin 'VF4' is not a valid pin name on mcu 'mcu'
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-86-g6026a99a'
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
Start printer at Sun Jan 22 13:34:38 2023 (1674394479.0 21.3)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01
enable_pin = PE5

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
webhooks client 281473618278432: New connection
webhooks client 281473618278432: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-86-g6026a99a'
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
Start printer at Sun Jan 22 13:53:55 2023 (1674395635.8 95.7)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01
enable_pin = PE5

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
webhooks client 281473060500000: New connection
webhooks client 281473060500000: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00: [Errno 2] No such file or directory: '/dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00'
MCU error during connect
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/mcu.py", line 777, in _mcu_identify
    self._serial.connect_uart(self._serialport, self._baud, rts)
  File "/home/pi/klipper/klippy/serialhdl.py", line 182, in connect_uart
    self._error("Unable to connect")
  File "/home/pi/klipper/klippy/serialhdl.py", line 61, in _error
    raise error(self.warn_prefix + (msg % params))
serialhdl.error: mcu 'mcu': Unable to connect

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/pi/klipper/klippy/klippy.py", line 176, in _connect
    self.send_event("klippy:mcu_identify")
  File "/home/pi/klipper/klippy/klippy.py", line 263, in send_event
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/klippy.py", line 263, in <listcomp>
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/mcu.py", line 782, in _mcu_identify
    raise error(str(e))
mcu.error: mcu 'mcu': Unable to connect
Build file /home/pi/klipper/klippy/../.config(669): Thu Jan 19 09:01:08 2023
========= Last MCU build config =========
# CONFIG_LOW_LEVEL_OPTIONS is not set
# CONFIG_MACH_AVR is not set
# CONFIG_MACH_ATSAM is not set
# CONFIG_MACH_ATSAMD is not set
# CONFIG_MACH_LPC176X is not set
# CONFIG_MACH_STM32 is not set
# CONFIG_MACH_RP2040 is not set
# CONFIG_MACH_PRU is not set
CONFIG_MACH_LINUX=y
# CONFIG_MACH_SIMU is not set
CONFIG_STEP_DELAY=2
CONFIG_BOARD_DIRECTORY="linux"
CONFIG_CLOCK_FREQ=50000000
CONFIG_LINUX_SELECT=y
CONFIG_USB_VENDOR_ID=0x1d50
CONFIG_USB_DEVICE_ID=0x614e
CONFIG_USB_SERIAL_NUMBER="12345"
CONFIG_HAVE_GPIO=y
CONFIG_HAVE_GPIO_ADC=y
CONFIG_HAVE_GPIO_SPI=y
CONFIG_HAVE_GPIO_I2C=y
CONFIG_HAVE_GPIO_HARD_PWM=y
CONFIG_HAVE_GPIO_BITBANGING=y
CONFIG_INLINE_STEPPER_HACK=y
=======================
Build file /home/pi/klipper/klippy/../out/klipper.dict(9214): Thu Jan 19 09:00:40 2023
Last MCU build version: v0.11.0-86-g6026a99a
Last MCU build tools: gcc: (Debian 10.2.1-6) 10.2.1 20210110 binutils: (GNU Binutils for Debian) 2.35.2
Last MCU build config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
Build file /home/pi/klipper/klippy/../out/klipper.elf(817776): Thu Jan 19 09:01:01 2023
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.11.0-86-g6026a99a'
CPU: 4 core ?
Python: '3.9.2 (default, Feb 28 2021, 17:03:44) \n[GCC 10.2.1 20210110]'
Start printer at Sun Jan 22 13:57:26 2023 (1674395846.2 21.5)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-268.840580 slope=1305.652174
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (47.0, 45.4)    | (20.0, 20.0)
  1   | (87.8, 45.4)    | (60.8, 20.0)
  2   | (128.6, 45.4)   | (101.7, 20.0)
  3   | (169.5, 45.4)   | (142.5, 20.0)
  4   | (210.3, 45.4)   | (183.3, 20.0)
  5   | (251.1, 45.4)   | (224.1, 20.0)
  6   | (291.9, 45.4)   | (265.0, 20.0)
  7   | (291.9, 85.4)   | (265.0, 60.0)
  8   | (251.1, 85.4)   | (224.2, 60.0)
  9   | (210.3, 85.4)   | (183.3, 60.0)
  10  | (169.5, 85.4)   | (142.5, 60.0)
  11  | (128.6, 85.4)   | (101.7, 60.0)
  12  | (87.8, 85.4)    | (60.8, 60.0)
  13  | (47.0, 85.4)    | (20.0, 60.0)
  14  | (47.0, 125.4)   | (20.0, 100.0)
  15  | (87.8, 125.4)   | (60.8, 100.0)
  16  | (128.6, 125.4)  | (101.7, 100.0)
  17  | (169.5, 125.4)  | (142.5, 100.0)
  18  | (210.3, 125.4)  | (183.3, 100.0)
  19  | (251.1, 125.4)  | (224.1, 100.0)
  20  | (291.9, 125.4)  | (265.0, 100.0)
  21  | (291.9, 165.4)  | (265.0, 140.0)
  22  | (251.1, 165.4)  | (224.2, 140.0)
  23  | (210.3, 165.4)  | (183.3, 140.0)
  24  | (169.5, 165.4)  | (142.5, 140.0)
  25  | (128.6, 165.4)  | (101.7, 140.0)
  26  | (87.8, 165.4)   | (60.8, 140.0)
  27  | (47.0, 165.4)   | (20.0, 140.0)
  28  | (47.0, 205.4)   | (20.0, 180.0)
  29  | (87.8, 205.4)   | (60.8, 180.0)
  30  | (128.6, 205.4)  | (101.7, 180.0)
  31  | (169.5, 205.4)  | (142.5, 180.0)
  32  | (210.3, 205.4)  | (183.3, 180.0)
  33  | (251.1, 205.4)  | (224.1, 180.0)
  34  | (291.9, 205.4)  | (265.0, 180.0)
  35  | (291.9, 245.4)  | (265.0, 220.0)
  36  | (251.1, 245.4)  | (224.2, 220.0)
  37  | (210.3, 245.4)  | (183.3, 220.0)
  38  | (169.5, 245.4)  | (142.5, 220.0)
  39  | (128.6, 245.4)  | (101.7, 220.0)
  40  | (87.8, 245.4)   | (60.8, 220.0)
  41  | (47.0, 245.4)   | (20.0, 220.0)
  42  | (47.0, 285.4)   | (20.0, 260.0)
  43  | (87.8, 285.4)   | (60.8, 260.0)
  44  | (128.6, 285.4)  | (101.7, 260.0)
  45  | (169.5, 285.4)  | (142.5, 260.0)
  46  | (210.3, 285.4)  | (183.3, 260.0)
  47  | (251.1, 285.4)  | (224.1, 260.0)
  48  | (291.9, 285.4)  | (265.0, 260.0)
TMC stepper_x failed to init: Unable to read tmc uart 'stepper_x' register IFCNT
TMC extruder failed to init: Unable to read tmc uart 'extruder' register IFCNT
TMC stepper_z failed to init: Unable to read tmc uart 'stepper_z' register IFCNT
TMC stepper_z1 failed to init: Unable to read tmc uart 'stepper_z1' register IFCNT
TMC stepper_z2 failed to init: Unable to read tmc uart 'stepper_z2' register IFCNT
Unable to obtain tmc stepper_x phase
Unable to obtain tmc stepper_z phase
Unable to obtain tmc stepper_z1 phase
Unable to obtain tmc stepper_z2 phase
Starting heater checks for extruder
Unable to obtain tmc extruder phase
Stats 27.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2298 bytes_read=5256 bytes_retransmit=9 bytes_invalid=0 send_seq=214 receive_seq=214 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64001231 Manta_M8P: temp=0.0 raspberry_pi: temp=50.8  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=2.36 cputime=5.546 memavail=633660 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
webhooks client 281472805714288: New connection
webhooks client 281472805714288: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
Stats 28.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2304 bytes_read=5319 bytes_retransmit=9 bytes_invalid=0 send_seq=215 receive_seq=215 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000643 Manta_M8P: temp=37.8 raspberry_pi: temp=50.1  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=2.36 cputime=5.564 memavail=624120 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 281472805714288
webhooks: registering remote method 'reboot_machine' for connection id: 281472805714288
webhooks: registering remote method 'pause_job_queue' for connection id: 281472805714288
webhooks: registering remote method 'start_job_queue' for connection id: 281472805714288
Stats 29.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2310 bytes_read=5500 bytes_retransmit=9 bytes_invalid=0 send_seq=216 receive_seq=216 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000307 Manta_M8P: temp=38.5 raspberry_pi: temp=50.6  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=2.36 cputime=5.665 memavail=619024 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 30.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2316 bytes_read=5666 bytes_retransmit=9 bytes_invalid=0 send_seq=217 receive_seq=217 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000423 Manta_M8P: temp=39.0 raspberry_pi: temp=50.4  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=2.49 cputime=5.723 memavail=611740 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 31.7: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=2322 bytes_read=5876 bytes_retransmit=9 bytes_invalid=0 send_seq=218 receive_seq=218 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000647 Manta_M8P: temp=39.6 raspberry_pi: temp=49.9  heater_bed: target=0 temp=27.0 pwm=0.000 sysload=2.49 cputime=5.756 memavail=605120 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 32.7: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=2328 bytes_read=6057 bytes_retransmit=9 bytes_invalid=0 send_seq=219 receive_seq=219 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000592 Manta_M8P: temp=40.0 raspberry_pi: temp=50.5  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=2.49 cputime=5.785 memavail=614160 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 33.7: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=2334 bytes_read=6223 bytes_retransmit=9 bytes_invalid=0 send_seq=220 receive_seq=220 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000586 Manta_M8P: temp=40.3 raspberry_pi: temp=50.3  heater_bed: target=0 temp=27.0 pwm=0.000 sysload=2.49 cputime=5.814 memavail=604988 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 34.7: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=2340 bytes_read=6418 bytes_retransmit=9 bytes_invalid=0 send_seq=221 receive_seq=221 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000591 Manta_M8P: temp=40.6 raspberry_pi: temp=48.9  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=2.49 cputime=5.840 memavail=605100 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 35.7: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=2346 bytes_read=6599 bytes_retransmit=9 bytes_invalid=0 send_seq=222 receive_seq=222 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000579 Manta_M8P: temp=40.8 raspberry_pi: temp=47.6  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=2.29 cputime=5.864 memavail=604600 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 36.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2352 bytes_read=6779 bytes_retransmit=9 bytes_invalid=0 send_seq=223 receive_seq=223 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000597 Manta_M8P: temp=41.0 raspberry_pi: temp=46.0  heater_bed: target=0 temp=27.3 pwm=0.000 sysload=2.29 cputime=5.888 memavail=604604 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 37.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2358 bytes_read=6974 bytes_retransmit=9 bytes_invalid=0 send_seq=224 receive_seq=224 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000604 Manta_M8P: temp=41.1 raspberry_pi: temp=45.9  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=2.29 cputime=5.912 memavail=603352 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 38.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2364 bytes_read=7155 bytes_retransmit=9 bytes_invalid=0 send_seq=225 receive_seq=225 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000611 Manta_M8P: temp=41.2 raspberry_pi: temp=45.7  heater_bed: target=0 temp=27.3 pwm=0.000 sysload=2.29 cputime=5.932 memavail=604568 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 39.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2370 bytes_read=7321 bytes_retransmit=9 bytes_invalid=0 send_seq=226 receive_seq=226 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000607 Manta_M8P: temp=41.6 raspberry_pi: temp=45.4  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=2.29 cputime=5.955 memavail=605120 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 40.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000012 bytes_write=2406 bytes_read=7526 bytes_retransmit=9 bytes_invalid=0 send_seq=229 receive_seq=229 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000609 Manta_M8P: temp=41.7 raspberry_pi: temp=45.3  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=2.11 cputime=5.982 memavail=604616 print_time=44.058 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 41.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2412 bytes_read=7721 bytes_retransmit=9 bytes_invalid=0 send_seq=230 receive_seq=230 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000622 Manta_M8P: temp=41.6 raspberry_pi: temp=45.5  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=2.11 cputime=6.006 memavail=604616 print_time=44.058 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 42.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2418 bytes_read=7887 bytes_retransmit=9 bytes_invalid=0 send_seq=231 receive_seq=231 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000631 Manta_M8P: temp=41.8 raspberry_pi: temp=45.3  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=2.11 cputime=6.029 memavail=604144 print_time=44.058 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 43.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2439 bytes_read=8087 bytes_retransmit=9 bytes_invalid=0 send_seq=233 receive_seq=233 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000636 Manta_M8P: temp=41.9 raspberry_pi: temp=46.0  heater_bed: target=0 temp=26.8 pwm=0.000 sysload=2.11 cputime=6.055 memavail=603892 print_time=47.044 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 44.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2445 bytes_read=8268 bytes_retransmit=9 bytes_invalid=0 send_seq=234 receive_seq=234 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000643 Manta_M8P: temp=42.1 raspberry_pi: temp=46.2  heater_bed: target=0 temp=26.8 pwm=0.000 sysload=2.11 cputime=6.079 memavail=603896 print_time=47.044 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 45.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2466 bytes_read=8439 bytes_retransmit=9 bytes_invalid=0 send_seq=236 receive_seq=236 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000652 Manta_M8P: temp=42.1 raspberry_pi: temp=46.3  heater_bed: target=0 temp=26.8 pwm=0.000 sysload=1.94 cputime=6.105 memavail=613676 print_time=49.117 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.3 pwm=0.000
Stats 46.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2472 bytes_read=8648 bytes_retransmit=9 bytes_invalid=0 send_seq=237 receive_seq=237 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000662 Manta_M8P: temp=42.3 raspberry_pi: temp=46.1  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.94 cputime=6.129 memavail=613264 print_time=49.117 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 47.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2478 bytes_read=8829 bytes_retransmit=9 bytes_invalid=0 send_seq=238 receive_seq=238 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000665 Manta_M8P: temp=42.6 raspberry_pi: temp=46.0  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.94 cputime=6.153 memavail=612788 print_time=49.117 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 48.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2497 bytes_read=9000 bytes_retransmit=9 bytes_invalid=0 send_seq=240 receive_seq=240 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000667 Manta_M8P: temp=42.4 raspberry_pi: temp=45.8  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.94 cputime=6.179 memavail=612312 print_time=52.464 buffer_time=0.214 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 49.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2503 bytes_read=9195 bytes_retransmit=9 bytes_invalid=0 send_seq=241 receive_seq=241 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000671 Manta_M8P: temp=42.6 raspberry_pi: temp=45.3  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.94 cputime=6.203 memavail=612564 print_time=52.464 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 50.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2509 bytes_read=9376 bytes_retransmit=9 bytes_invalid=0 send_seq=242 receive_seq=242 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000680 Manta_M8P: temp=42.6 raspberry_pi: temp=45.7  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.78 cputime=6.227 memavail=612312 print_time=52.464 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 51.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2521 bytes_read=9572 bytes_retransmit=9 bytes_invalid=0 send_seq=244 receive_seq=244 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000683 Manta_M8P: temp=42.6 raspberry_pi: temp=45.6  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.78 cputime=6.251 memavail=612428 print_time=52.464 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 52.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2527 bytes_read=9767 bytes_retransmit=9 bytes_invalid=0 send_seq=245 receive_seq=245 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000683 Manta_M8P: temp=42.7 raspberry_pi: temp=45.7  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.78 cputime=6.275 memavail=612780 print_time=52.464 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 53.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2533 bytes_read=9948 bytes_retransmit=9 bytes_invalid=0 send_seq=246 receive_seq=246 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000685 Manta_M8P: temp=42.9 raspberry_pi: temp=45.4  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.78 cputime=6.299 memavail=612784 print_time=52.464 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 54.7: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000015 mcu_task_stddev=0.000011 bytes_write=2539 bytes_read=10114 bytes_retransmit=9 bytes_invalid=0 send_seq=247 receive_seq=247 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000686 Manta_M8P: temp=42.7 raspberry_pi: temp=45.7  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.78 cputime=6.327 memavail=612776 print_time=58.628 buffer_time=0.374 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Attempting MCU 'mcu' reset command
webhooks client 281472805714288: Disconnected
Restarting printer
Start printer at Sun Jan 22 13:58:00 2023 (1674395880.9 56.2)
===== Config file =====
[board_pins manta_m8p_tmc2209]
aliases = 
	
	x_step_pin=PE2,    x_dir_pin=PB4,    x_enable_pin=PC11,   x_uart_pin=PC10,   x_diag_pin=PF3,    x_endstop_pin=PF3,
	y_step_pin=PF12,   y_dir_pin=PF11,   y_enable_pin=PB3,    y_uart_pin=PF13,   y_diag_pin=PF4,    y_endstop_pin=PF4,
	z0_step_pin=PA10,  z0_dir_pin=PD15,  z0_enable_pin=PA15,  z0_uart_pin=PF8,   z0_diag_pin=null,
	z1_step_pin=PD12,  z1_dir_pin=PD11,  z1_enable_pin=PD14,  z1_uart_pin=PD13,  z1_diag_pin=null,
	z2_step_pin=PD10,  z2_dir_pin=PD8,   z2_enable_pin=PD9,   z2_uart_pin=PC7,   z2_diag_pin=null,
	z3_step_pin=PE6,	 z3_dir_pin=PC13,	 z3_enable_pin=PE5,	  z3_uart_pin=PC14,   z3_diag_pin=null,
	e_step_pin=PD7,    e_dir_pin=PD6,    e_enable_pin=PF10,   e_uart_pin=PF9,    e_diag_pin=null,   e_heater_pin=PE3,  e_sensor_pin=PA1,
	stepper_spi_mosi_pin=PA7,  stepper_spi_miso_pin=PA6,  stepper_spi_sclk_pin=PA5,
	
	adxl345_cs_pin=PB15,
	
	bltouch_sensor_pin=PB2,  bltouch_control_pin=PB1,
	probe_pin=PB2,
	
	fan_part_cooling_pin=PE6,
	fan_toolhead_cooling_pin=PE0,
	fan_controller_board_pin=PC12,
	
	heater_bed_heating_pin=PB7,
	heater_bed_sensor_pin=PA0 ,
	
	
	
	EXP1_1=PE9, EXP1_2=PE10,
	EXP1_3=PE11, EXP1_4=PE12,
	EXP1_5=PE13, EXP1_6=PE14,
	EXP1_7=PE15, EXP1_8=PB10,
	EXP1_9=<GND>, EXP1_10=<5V>,
	
	
	EXP2_1=PB14, EXP2_2=PB13,
	EXP2_3=PF7, EXP2_4=PB12,
	EXP2_5=PE7, EXP2_6=PB11,
	EXP2_7=PE8, EXP2_8=<RST>,
	EXP2_9=<GND>, EXP2_10=PC5

[mcu]
baud = 250000
serial = /dev/serial/by-id/usb-Klipper_stm32g0b1xx_5C00390009504B4633373520-if00

[temperature_sensor Manta_M8P]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[adxl345]
spi_software_mosi_pin = stepper_spi_mosi_pin
spi_software_miso_pin = stepper_spi_miso_pin
spi_software_sclk_pin = stepper_spi_sclk_pin
cs_pin = adxl345_cs_pin

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[temperature_sensor raspberry_pi]
sensor_type = temperature_host

[skew_correction]

[input_shaper]

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[heater_bed]
heater_pin = heater_bed_heating_pin
sensor_pin = heater_bed_sensor_pin
sensor_type = Generic 3950
min_temp = 0
max_temp = 120
pwm_cycle_time = 0.02
control = pid
pid_kp = 22.2
pid_ki = 1.08
pid_kd = 114

[fan]
pin = PE4
shutdown_speed = 1.0
tachometer_pin = PC13
tachometer_poll_interval = 0.0005
cycle_time = 0.01
enable_pin = PE5

[heater_fan toolhead_cooling_fan]
pin = fan_toolhead_cooling_pin
fan_speed = 1

[controller_fan controller_fan]
pin = fan_controller_board_pin

[printer]
kinematics = corexy
max_velocity = 1000
max_accel = 15000
max_accel_to_decel = 7500
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[homing_override]
set_position_z = -5
axes = xyz
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_hop = printer["gcode_macro RatOS"].homing_z_hop|float %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	
	M400
	G90
	G0 Z{z_hop} F{z_speed}
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_raise_error("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_speed}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config["tmc2209 stepper_x"].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config["tmc2209 stepper_y"].run_current}
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro RatOS]
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_nozzle_priming = "primeblob"
variable_nozzle_prime_start_x = "max"
variable_nozzle_prime_start_y = "min"
variable_nozzle_prime_direction = "auto"
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_start_print_heat_chamber_bed_temp = 115
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 300
variable_macro_z_speed = 10
variable_end_print_park_z_hop = 20
variable_homing = "endstops"
variable_homing_z_hop = 25
variable_sensorless_x_current = 0.6
variable_sensorless_y_current = 0.9
variable_z_probe = "stowable"
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
gcode = 
	ECHO_RATOS_VARS
variable_stowable_probe_position_preflight = [ 30, 60 ]
variable_stowable_probe_position_side = [  13, 60 ]
variable_stowable_probe_position_dock = [   13, 6.5 ]
variable_stowable_probe_position_exit = [   60, 6.5 ]
variable_stowable_probe_batch_mode_enabled = False
variable_stowable_probe_state = None
variable_homing_x = "endstop"
variable_homing_y = "endstop"

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = printer.toolhead.axis_minimum.x + 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 F60 E20
	
	M106 S102
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_BED_MESH
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	M117 Pre-heating extruder...
	
	
	M104 S150
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
	{% endif %}
	M117 Adjusting for tilt...
	
	Z_TILT_ADJUST
	M117 Rehoming after tilt adjustment...
	
	G28 Z

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CALIBRATE PROFILE=ratos
	{% endif %}
	BED_MESH_PROFILE LOAD=ratos

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	SAVE_GCODE_STATE NAME=end_print_state
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	M117 Done :)
	RESPOND MSG="Done :)"
	RESTORE_GCODE_STATE NAME=end_print_state

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_shell_command delete_and_restore_printer_data_dirs]
command = /home/pi/printer_data/config/RatOS/scripts/delete-and-restore-printer-data.sh
timeout = 10.

[gcode_macro DELETE_AND_RESTORE_PRINTER_DATA_DIRS]
gcode = 
	RUN_SHELL_COMMAND CMD=delete_and_restore_printer_data_dirs

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[stepper_x]
step_pin = x_step_pin
dir_pin = x_dir_pin
enable_pin = !x_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 0
endstop_pin = ^x_endstop_pin

[stepper_y]
step_pin = y_step_pin
dir_pin = y_dir_pin
enable_pin = !y_enable_pin
rotation_distance = 40
microsteps = 64
homing_speed = 50
homing_retract_dist = 5.0
position_max = 300
position_endstop = 300
endstop_pin = ^y_endstop_pin
homing_positive_dir = true

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = z0_step_pin
dir_pin = !z0_dir_pin
enable_pin = !z0_enable_pin
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 300

[stepper_z1]
step_pin = z1_step_pin
dir_pin = !z1_dir_pin
enable_pin = !z1_enable_pin
rotation_distance = 4
microsteps = 64

[stepper_z2]
step_pin = z2_step_pin
dir_pin = !z2_dir_pin
enable_pin = !z2_enable_pin
rotation_distance = 4
microsteps = 64

[extruder]
step_pin = e_step_pin
dir_pin = !e_dir_pin
enable_pin = !e_enable_pin
microsteps = 16
rotation_distance = 22.67895
gear_ratio = 50:8
full_steps_per_rotation = 200
max_extrude_only_distance = 200
max_extrude_only_velocity = 75.0
max_extrude_only_accel = 1500
filament_diameter = 1.750
nozzle_diameter = 0.4
heater_pin = e_heater_pin
sensor_type = ATC Semitec 104GT-2
sensor_pin = e_sensor_pin
min_extrude_temp = 170
min_temp = 0
max_temp = 285
pressure_advance = 0.03
control = pid
pid_kp = 28.413
pid_ki = 1.334
pid_kd = 151.300

[bed_mesh]
speed = 300
horizontal_move_z = 5
mesh_min = 20,20
mesh_max = 265,260
probe_count = 7,7
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 300
z_positions = 
	0,0
	150,300
	300,0
points = 
	60,60
	185,270
	260,60
horizontal_move_z = 20
retries = 10
retry_tolerance = 0.02

[tmc2209 stepper_x]
stealthchop_threshold = 0
interpolate = False
uart_pin = x_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_y]
stealthchop_threshold = 0
interpolate = False
uart_pin = y_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 extruder]
uart_pin = e_uart_pin
run_current = 0.35
stealthchop_threshold = 0
interpolate = True

[tmc2209 stepper_z]
stealthchop_threshold = 0
interpolate = False
uart_pin = z0_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z1]
stealthchop_threshold = 0
interpolate = False
uart_pin = z1_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[tmc2209 stepper_z2]
stealthchop_threshold = 0
interpolate = False
uart_pin = z2_uart_pin
run_current = 1.6
driver_tbl = 2
driver_toff = 3
driver_hend = 0
driver_hstrt = 6

[gcode_macro _ASSERT_PROBE_STATE]
description = ensures probe is in a known state; QUERY_PROBE must have been called before this macro!
gcode = 
	
	
	
	{% set last_query_state = "stowed" if printer.probe.last_query == 1 else "deployed" %}
	
	{% if params.MUST_BE != last_query_state %}
	{ action_raise_error("expected probe state to be {} but is {} ({})".format(params.MUST_BE, last_query_state, printer.probe.last_query)) }
	{% else %}
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_state VALUE="'{ last_query_state }'"
	{% endif %}

[gcode_macro ASSERT_PROBE_DEPLOYED]
description = error if probe not deployed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=deployed

[gcode_macro ASSERT_PROBE_STOWED]
description = error if probe not stowed
gcode = 
	M400
	G4 P100
	
	QUERY_PROBE
	_ASSERT_PROBE_STATE MUST_BE=stowed

[gcode_macro STOWABLE_PROBE_BEGIN_BATCH]
description = Begin stowable probe batch mode
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=True
	RESPOND TYPE=command MSG="Probe batch mode enabled"

[gcode_macro STOWABLE_PROBE_END_BATCH]
description = End stowable probe batch mode and stow probe
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_batch_mode_enabled VALUE=False
	RESPOND TYPE=command MSG="Probe batch mode disabled"
	STOW_PROBE

[gcode_macro DEPLOY_PROBE]
description = Deploy a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled and RatOS.stowable_probe_state == "deployed" %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: already deployed"
	{% else %}
	RESPOND TYPE=command MSG="Deploying probe"
	
	ASSERT_PROBE_STOWED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F{z_speed}
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_DEPLOYED
	
	{% endif %}

[gcode_macro STOW_PROBE]
description = Stow a stowable probe
gcode = 
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	
	{% if RatOS.stowable_probe_batch_mode_enabled %}
	RESPOND TYPE=command MSG="Probe batch mode enabled: not stowing"
	{% else %}
	RESPOND TYPE=command MSG="Stowing probe"
	
	ASSERT_PROBE_DEPLOYED
	
	G90
	
	G0 Z{ RatOS.homing_z_hop } F3000
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_exit[0] } Y{ RatOS.stowable_probe_position_exit[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_dock[0] } Y{ RatOS.stowable_probe_position_dock[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_side[0] } Y{ RatOS.stowable_probe_position_side[1] } F{ speed }
	
	G0 X{ RatOS.stowable_probe_position_preflight[0] } Y{ RatOS.stowable_probe_position_preflight[1] } F{ speed }
	
	ASSERT_PROBE_STOWED
	{% endif %}

[gcode_macro BED_MESH_CALIBRATE]
rename_existing = BED_MESH_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	DEPLOY_PROBE
	BED_MESH_CALIBRATE_ORIG {args|join(' ')}
	STOW_PROBE

[gcode_macro PROBE_CALIBRATE]
rename_existing = PROBE_CALIBRATE_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	{% set RatOS = printer["gcode_macro RatOS"] %}
	{% set speed = RatOS.macro_travel_speed * 60 %}
	DEPLOY_PROBE
	G90
	G0 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F{ speed }
	PROBE_CALIBRATE_ORIG {args|join(' ')}
	SAVE_GCODE_STATE name=probe_calibrate
	STOW_PROBE
	RESTORE_GCODE_STATE name=probe_calibrate MOVE=1 MOVE_SPEED={RatOS.macro_travel_speed|float}

[gcode_macro PROBE_ACCURACY]
rename_existing = PROBE_ACCURACY_ORIG
gcode = 
	{% set args = [] %}
	{% for p in params %}
	{% set tmp = args.append('%s=%s' % (p, params[p])) %}
	{% endfor %}
	ASSERT_PROBE_DEPLOYED
	PROBE_ACCURACY_ORIG {args|join(' ')}

[probe]
pin = ^probe_pin
x_offset = -26.96
y_offset = -25.4
speed = 5
lift_speed = 15
samples = 4
sample_retract_dist = 1.0
z_offset = 0.0

[firmware_retraction]
retract_speed = 60
unretract_extra_length = 0
unretract_speed = 60
retract_length = 0.5
=======================
Extruder max_extrude_ratio=0.266081
mcu 'mcu': Starting serial connect
webhooks client 281472806005344: New connection
webhooks client 281472806005344: Client info {'program': 'Moonraker', 'version': 'v0.7.1-809-gc964e68'}
Loaded MCU 'mcu' 105 commands (v0.11.0-62-gf1203d56 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.35.2-2+14+b2) 2.35.2)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PA9_PA10=PA9,PA10 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c2_PB13_PB14=PB13,PB14 BUS_PINS_i2c3_PB3_PB4=PB3,PB4 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3=PB4,PB5,PB3 CLOCK_FREQ=64000000 MCU=stm32g0b1xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PF0,PF1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu_temperature 'mcu' nominal base=-268.840580 slope=1305.652174
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (47.0, 45.4)    | (20.0, 20.0)
  1   | (87.8, 45.4)    | (60.8, 20.0)
  2   | (128.6, 45.4)   | (101.7, 20.0)
  3   | (169.5, 45.4)   | (142.5, 20.0)
  4   | (210.3, 45.4)   | (183.3, 20.0)
  5   | (251.1, 45.4)   | (224.1, 20.0)
  6   | (291.9, 45.4)   | (265.0, 20.0)
  7   | (291.9, 85.4)   | (265.0, 60.0)
  8   | (251.1, 85.4)   | (224.2, 60.0)
  9   | (210.3, 85.4)   | (183.3, 60.0)
  10  | (169.5, 85.4)   | (142.5, 60.0)
  11  | (128.6, 85.4)   | (101.7, 60.0)
  12  | (87.8, 85.4)    | (60.8, 60.0)
  13  | (47.0, 85.4)    | (20.0, 60.0)
  14  | (47.0, 125.4)   | (20.0, 100.0)
  15  | (87.8, 125.4)   | (60.8, 100.0)
  16  | (128.6, 125.4)  | (101.7, 100.0)
  17  | (169.5, 125.4)  | (142.5, 100.0)
  18  | (210.3, 125.4)  | (183.3, 100.0)
  19  | (251.1, 125.4)  | (224.1, 100.0)
  20  | (291.9, 125.4)  | (265.0, 100.0)
  21  | (291.9, 165.4)  | (265.0, 140.0)
  22  | (251.1, 165.4)  | (224.2, 140.0)
  23  | (210.3, 165.4)  | (183.3, 140.0)
  24  | (169.5, 165.4)  | (142.5, 140.0)
  25  | (128.6, 165.4)  | (101.7, 140.0)
  26  | (87.8, 165.4)   | (60.8, 140.0)
  27  | (47.0, 165.4)   | (20.0, 140.0)
  28  | (47.0, 205.4)   | (20.0, 180.0)
  29  | (87.8, 205.4)   | (60.8, 180.0)
  30  | (128.6, 205.4)  | (101.7, 180.0)
  31  | (169.5, 205.4)  | (142.5, 180.0)
  32  | (210.3, 205.4)  | (183.3, 180.0)
  33  | (251.1, 205.4)  | (224.1, 180.0)
  34  | (291.9, 205.4)  | (265.0, 180.0)
  35  | (291.9, 245.4)  | (265.0, 220.0)
  36  | (251.1, 245.4)  | (224.2, 220.0)
  37  | (210.3, 245.4)  | (183.3, 220.0)
  38  | (169.5, 245.4)  | (142.5, 220.0)
  39  | (128.6, 245.4)  | (101.7, 220.0)
  40  | (87.8, 245.4)   | (60.8, 220.0)
  41  | (47.0, 245.4)   | (20.0, 220.0)
  42  | (47.0, 285.4)   | (20.0, 260.0)
  43  | (87.8, 285.4)   | (60.8, 260.0)
  44  | (128.6, 285.4)  | (101.7, 260.0)
  45  | (169.5, 285.4)  | (142.5, 260.0)
  46  | (210.3, 285.4)  | (183.3, 260.0)
  47  | (251.1, 285.4)  | (224.1, 260.0)
  48  | (291.9, 285.4)  | (265.0, 260.0)
TMC stepper_x failed to init: Unable to read tmc uart 'stepper_x' register IFCNT
TMC extruder failed to init: Unable to read tmc uart 'extruder' register IFCNT
TMC stepper_z failed to init: Unable to read tmc uart 'stepper_z' register IFCNT
TMC stepper_z1 failed to init: Unable to read tmc uart 'stepper_z1' register IFCNT
TMC stepper_z2 failed to init: Unable to read tmc uart 'stepper_z2' register IFCNT
Unable to obtain tmc stepper_x phase
Unable to obtain tmc stepper_z phase
Unable to obtain tmc stepper_z1 phase
Unable to obtain tmc stepper_z2 phase
Starting heater checks for extruder
Unable to obtain tmc extruder phase
Stats 59.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=2364 bytes_read=5302 bytes_retransmit=9 bytes_invalid=0 send_seq=226 receive_seq=226 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000047 Manta_M8P: temp=0.0 raspberry_pi: temp=48.3  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=1.64 cputime=8.737 memavail=610156 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 281472806005344
webhooks: registering remote method 'reboot_machine' for connection id: 281472806005344
webhooks: registering remote method 'pause_job_queue' for connection id: 281472806005344
webhooks: registering remote method 'start_job_queue' for connection id: 281472806005344
Stats 60.2: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2370 bytes_read=5351 bytes_retransmit=9 bytes_invalid=0 send_seq=227 receive_seq=227 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000275 Manta_M8P: temp=0.0 raspberry_pi: temp=47.9  heater_bed: target=0 temp=0.0 pwm=0.000 sysload=1.51 cputime=8.800 memavail=609764 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=0.0 pwm=0.000
Stats 61.2: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2376 bytes_read=5517 bytes_retransmit=9 bytes_invalid=0 send_seq=228 receive_seq=228 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000356 Manta_M8P: temp=41.4 raspberry_pi: temp=47.7  heater_bed: target=0 temp=27.0 pwm=0.000 sysload=1.51 cputime=8.840 memavail=609292 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.2 pwm=0.000
Stats 62.2: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2382 bytes_read=5712 bytes_retransmit=9 bytes_invalid=0 send_seq=229 receive_seq=229 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000482 Manta_M8P: temp=41.7 raspberry_pi: temp=47.2  heater_bed: target=0 temp=27.3 pwm=0.000 sysload=1.51 cputime=8.864 memavail=611768 print_time=0.001 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 63.2: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2426 bytes_read=5904 bytes_retransmit=9 bytes_invalid=0 send_seq=232 receive_seq=232 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000488 Manta_M8P: temp=42.3 raspberry_pi: temp=48.7  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.51 cputime=8.892 memavail=612832 print_time=7.407 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 64.2: gcodein=0  mcu: mcu_awake=0.018 mcu_task_avg=0.000018 mcu_task_stddev=0.000023 bytes_write=2432 bytes_read=6071 bytes_retransmit=9 bytes_invalid=0 send_seq=233 receive_seq=233 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000551 Manta_M8P: temp=42.6 raspberry_pi: temp=47.0  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.51 cputime=8.915 memavail=613596 print_time=7.407 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 65.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2438 bytes_read=6281 bytes_retransmit=9 bytes_invalid=0 send_seq=234 receive_seq=234 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000573 Manta_M8P: temp=42.5 raspberry_pi: temp=47.1  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.47 cputime=8.940 memavail=613364 print_time=7.407 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 66.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2444 bytes_read=6463 bytes_retransmit=9 bytes_invalid=0 send_seq=235 receive_seq=235 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000600 Manta_M8P: temp=42.8 raspberry_pi: temp=47.1  heater_bed: target=0 temp=27.3 pwm=0.000 sysload=1.47 cputime=8.963 memavail=613120 print_time=7.407 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 67.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2450 bytes_read=6630 bytes_retransmit=9 bytes_invalid=0 send_seq=236 receive_seq=236 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000608 Manta_M8P: temp=42.9 raspberry_pi: temp=47.4  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.47 cputime=8.987 memavail=613672 print_time=7.407 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 68.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2456 bytes_read=6826 bytes_retransmit=9 bytes_invalid=0 send_seq=237 receive_seq=237 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000639 Manta_M8P: temp=43.2 raspberry_pi: temp=47.1  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.47 cputime=9.011 memavail=613692 print_time=7.407 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 69.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2483 bytes_read=7013 bytes_retransmit=9 bytes_invalid=0 send_seq=239 receive_seq=239 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000649 Manta_M8P: temp=43.3 raspberry_pi: temp=47.2  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.47 cputime=9.037 memavail=613692 print_time=14.090 buffer_time=0.016 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 70.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2489 bytes_read=7194 bytes_retransmit=9 bytes_invalid=0 send_seq=240 receive_seq=240 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000654 Manta_M8P: temp=43.3 raspberry_pi: temp=47.3  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.43 cputime=9.062 memavail=613692 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 71.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2495 bytes_read=7390 bytes_retransmit=9 bytes_invalid=0 send_seq=241 receive_seq=241 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000656 Manta_M8P: temp=43.2 raspberry_pi: temp=47.4  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.43 cputime=9.087 memavail=614700 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 72.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2501 bytes_read=7572 bytes_retransmit=9 bytes_invalid=0 send_seq=242 receive_seq=242 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000654 Manta_M8P: temp=43.5 raspberry_pi: temp=47.3  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.43 cputime=9.110 memavail=614700 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 73.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2507 bytes_read=7739 bytes_retransmit=9 bytes_invalid=0 send_seq=243 receive_seq=243 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000662 Manta_M8P: temp=43.5 raspberry_pi: temp=47.1  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.43 cputime=9.135 memavail=615204 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 74.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2513 bytes_read=7935 bytes_retransmit=9 bytes_invalid=0 send_seq=244 receive_seq=244 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000665 Manta_M8P: temp=43.6 raspberry_pi: temp=47.4  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.43 cputime=9.160 memavail=615464 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 75.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2519 bytes_read=8131 bytes_retransmit=9 bytes_invalid=0 send_seq=245 receive_seq=245 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000661 Manta_M8P: temp=43.8 raspberry_pi: temp=47.1  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.39 cputime=9.185 memavail=616024 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 76.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2525 bytes_read=8298 bytes_retransmit=9 bytes_invalid=0 send_seq=246 receive_seq=246 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000667 Manta_M8P: temp=43.7 raspberry_pi: temp=47.5  heater_bed: target=0 temp=27.0 pwm=0.000 sysload=1.39 cputime=9.209 memavail=616288 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 77.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2531 bytes_read=8494 bytes_retransmit=9 bytes_invalid=0 send_seq=247 receive_seq=247 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000668 Manta_M8P: temp=43.9 raspberry_pi: temp=47.4  heater_bed: target=0 temp=27.3 pwm=0.000 sysload=1.39 cputime=9.235 memavail=616488 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 78.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2537 bytes_read=8676 bytes_retransmit=9 bytes_invalid=0 send_seq=248 receive_seq=248 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000670 Manta_M8P: temp=43.8 raspberry_pi: temp=48.4  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.39 cputime=9.259 memavail=616808 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 79.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2543 bytes_read=8843 bytes_retransmit=9 bytes_invalid=0 send_seq=249 receive_seq=249 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000672 Manta_M8P: temp=43.9 raspberry_pi: temp=48.3  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.39 cputime=9.284 memavail=617156 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
Stats 80.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2549 bytes_read=9053 bytes_retransmit=9 bytes_invalid=0 send_seq=250 receive_seq=250 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000675 Manta_M8P: temp=43.8 raspberry_pi: temp=48.3  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.52 cputime=9.308 memavail=617356 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 81.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2555 bytes_read=9235 bytes_retransmit=9 bytes_invalid=0 send_seq=251 receive_seq=251 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000676 Manta_M8P: temp=44.0 raspberry_pi: temp=48.2  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.52 cputime=9.333 memavail=617640 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 82.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2561 bytes_read=9402 bytes_retransmit=9 bytes_invalid=0 send_seq=252 receive_seq=252 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000679 Manta_M8P: temp=43.9 raspberry_pi: temp=47.9  heater_bed: target=0 temp=27.2 pwm=0.000 sysload=1.52 cputime=9.357 memavail=617440 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 83.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2567 bytes_read=9598 bytes_retransmit=9 bytes_invalid=0 send_seq=253 receive_seq=253 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000679 Manta_M8P: temp=44.1 raspberry_pi: temp=48.2  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.52 cputime=9.382 memavail=617696 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 84.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2573 bytes_read=9780 bytes_retransmit=9 bytes_invalid=0 send_seq=254 receive_seq=254 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000685 Manta_M8P: temp=44.1 raspberry_pi: temp=47.8  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.52 cputime=9.406 memavail=617896 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.0 pwm=0.000
Stats 85.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2579 bytes_read=9961 bytes_retransmit=9 bytes_invalid=0 send_seq=255 receive_seq=255 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000685 Manta_M8P: temp=44.2 raspberry_pi: temp=49.4  heater_bed: target=0 temp=27.1 pwm=0.000 sysload=1.48 cputime=9.430 memavail=617904 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.9 pwm=0.000
Stats 86.2: gcodein=0  mcu: mcu_awake=0.004 mcu_task_avg=0.000016 mcu_task_stddev=0.000012 bytes_write=2585 bytes_read=10157 bytes_retransmit=9 bytes_invalid=0 send_seq=256 receive_seq=256 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 stalled_bytes=0 freq=64000685 Manta_M8P: temp=44.1 raspberry_pi: temp=47.7  heater_bed: target=0 temp=27.3 pwm=0.000 sysload=1.48 cputime=9.455 memavail=617460 print_time=14.090 buffer_time=0.000 print_stall=0 extruder: target=0 temp=27.1 pwm=0.000
